<!doctype html>
<html lang="en">
<head>
	<link rel="stylesheet" type="text/css" href="styles/main.bundle.css">
	<meta charset="utf-8">
	<meta name="viewport"
		  content="width=device-width,minimum-scale=1,initial-scale=1">
	<title>Shift.MS Map</title>
</head>
<body>

	<div id="google-map-example"></div>
	
	<script>

		// initShiftMap gets called when the Google Map SDK is loaded
		window.initShiftMap = function(){

			// Example implementation
			var base = location.pathname;
			var map = document.getElementById('google-map-example');
			var assetsPath = base + 'img/';
			var isLogged = getParameterByName('user') || false; //change to false to see non logged component

			// Example of fetching data from an AJAX endpoint
			var loadData = $.get(base + "datasets/coordinates.json");

			// And then loading the map
			loadData.then(function(data) {

				var shiftMap = Maps.initialize({
					domElement: map, 
					data: data,
					assetsPath: assetsPath, 
					isLoggedIn: isLogged
				});

				// -- PUBLIC METHODS ------------------------------------------------ //

				// Public methods
				shiftMap.setWidthHeight( $(window).width(), $(window).height() );

				// E.g. resize map on window resize
				$( window ).on('resize', function(){
					shiftMap.setWidthHeight($(window).width(), $(window).height());
				});

				// In certain context, enable location plotting
				// For example, if you want to set this via URL
				if(getParameterByName('location')){
					shiftMap.enablePlotLocationMode();
				}

				// Insert some custom markers
				insertCustomMarkers( shiftMap );

				// -- LISTENERS ---------------------------------------------------- //
				shiftMap.onMapReady(function(){
					console.log('Event: onMapReady');
				});

				shiftMap.onMapChangeLocation(function(){
					console.log('Event: onMapChangeLocation');
				});

				shiftMap.onClickUser(function( user ){
					console.log('Event: onClickUser');
					alert('You clicked follow on ' + JSON.stringify(user));
				});

				shiftMap.onPlotLocation(function( place ){
					console.log('Event: onPlotLocation');
					alert('Plotted  ' + place.formatted_address );
					if( ! isLogged ){
						alert('e.g. ShiftMS Redirects to signup page with data: ' + place.formatted_address);
						location.href = location.origin + location.pathname + '?user=1';
					}
				});
				
				shiftMap.onAirBalloonClick(function() {
					console.log('Event: onAirBalloonClick');
					alert('Plot yourself using the search tool');
					shiftMap.enablePlotLocationMode();
				});
			});

			function insertCustomMarkers( shiftMap ){
				var obj = {
					'special/llama.png': 			 		[-19.33, -59.60],
					'special/mountains.png': 			[36.84, 92.46],
					'special/special-nessie.png': [55.94, -23.72],
					'special/boat.png': 					[28.51, -131.06],
					'special/trees1.png': 				[62.68, -129.47],
					'special/trees2.png': 				[53.98, -72.82],
					'special/trees3.png': 				[39.36, 60.07],
					'special/trees3.png': 				[42.81, 67.24],
					'special/turbine.png': 				[68.69, -42.17],
					'special/viking.png': 				[67.91, -1.04],
					'special/whaale.png': 				[72.71, -139.11],
					'special/pisaaa.png': 				[43.72, 10.40],
					'special/st.Pete.png':				[56.64, 34.07],
					'special/pyramids.png': 			[24.35, 26.89],
					'special/elephant.png': 			[-5.35, 21.45],
					'special/roo.png': 						[-26.37, 139.71]
				}
				for(var imgPath in obj){
					var each = obj[imgPath];
					shiftMap.insertMarker(each[0], each[1], assetsPath + imgPath, function( marker, imgUrl ){
						console.log('Marker clicked!', imgUrl, marker);
					});
				}
			}

			function getParameterByName(name) {
				var url = location.href;
			    name = name.replace(/[\[\]]/g, "\\$&");
			    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
			        results = regex.exec(url);
			    if (!results) return null;
			    if (!results[2]) return '';
			    return decodeURIComponent(results[2].replace(/\+/g, " "));
			}
		}
		
	</script>

	<!-- We can assume jQuery will be available from Wordpress -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

	<!-- This is the bundle generated by rollup.js -->
	<script src="js/maps.bundle.js?v=1"></script>

	<!-- Google maps -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR527NNTzbSOMy4D6ZFDLtEfsGl7Z3Q2I&libraries=places&callback=initShiftMap" async defer></script>

</body>
</html>